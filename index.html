<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manajemen Tagihan Jalur â€“ Versi Final Lengkap Offline</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
body { font-family: Inter, system-ui, sans-serif; background:#f8fafc; }
.card:active { transform: scale(0.98); }
</style>
</head>
<body class="pb-24">

<header class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow">
<div class="flex justify-between items-center max-w-4xl mx-auto">
<h1 class="font-bold text-lg">Tagihan Jalur â€“ Final</h1>
<div class="flex gap-2">
<button onclick="exportCSV()" class="bg-green-500 px-3 py-1 rounded text-xs font-bold">Export</button>
<button onclick="resetData()" class="bg-red-500 px-3 py-1 rounded text-xs font-bold">Reset</button>
</div>
</div>
</header>

<main class="max-w-4xl mx-auto p-4">

<div id="uploadArea" class="bg-white p-8 rounded-xl shadow text-center">
<p class="mb-4 font-bold">Upload CSV Sekali Saja</p>
<input type="file" id="csvFile" accept=".csv" class="hidden">
<button onclick="document.getElementById('csvFile').click()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold">Pilih CSV</button>
</div>

<div id="dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-3 my-4 hidden">
<div class="bg-white p-3 rounded shadow"><p class="text-xs">Total Toko</p><p id="statToko" class="font-bold text-xl">0</p></div>
<div class="bg-white p-3 rounded shadow"><p class="text-xs">Stok Kacang</p><p id="statKacang" class="font-bold">0</p></div>
<div class="bg-white p-3 rounded shadow"><p class="text-xs">Stok Kerupuk</p><p id="statKerupuk" class="font-bold">0</p></div>
<div class="bg-white p-3 rounded shadow"><p class="text-xs">Total Uang</p><p id="statUang" class="font-bold">Rp 0</p></div>
</div>

<div class="mb-4 hidden" id="filterArea">
<select id="filterToko" onchange="filterRender()" class="w-full p-3 rounded border font-bold">
<option value="all">-- Semua Toko --</option>
</select>
</div>

<div id="tokoList" class="space-y-4"></div>
</main>

<script>
let globalData = [];

function saveLocal(){ localStorage.setItem('tagihan_final', JSON.stringify(globalData)); }
function loadLocal(){
const d = localStorage.getItem('tagihan_final');
if(d){
globalData = JSON.parse(d);
document.getElementById('uploadArea').style.display='none';
document.getElementById('dashboard').classList.remove('hidden');
document.getElementById('filterArea').classList.remove('hidden');
populateFilter();
render(globalData);
}
}

window.onload = () => {
loadLocal();
document.getElementById('csvFile').addEventListener('change', handleCSV);
}

function handleCSV(e){
const file = e.target.files[0];
Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>{
globalData = r.data.map((d,i)=>({
id:i,
nama:d['Nama Toko']||'Tanpa Nama',
jalur:d['No Jalur']||'-',
kacang:parseInt(d['Kacang'])||0,
kerupuk:parseInt(d['Kerupuk'])||0,
foto:d['Foto']||'',
maps:d['Alamat / Link Maps']||'#',
laku:parseInt(d['Laku'])||0,
harga:parseInt(d['Harga Satuan'])||1500,
catatan:d['Catatan']||''
}));
saveLocal();
document.getElementById('uploadArea').style.display='none';
document.getElementById('dashboard').classList.remove('hidden');
document.getElementById('filterArea').classList.remove('hidden');
populateFilter();
render(globalData);
}});
}

function populateFilter(){
const f=document.getElementById('filterToko');
f.innerHTML='<option value="all">-- Semua Toko --</option>';
globalData.forEach(t=>{
const o=document.createElement('option');
o.value=t.id; o.textContent=t.nama;
f.appendChild(o);
});
}

function filterRender(){
const v=document.getElementById('filterToko').value;
render(v==='all'?globalData:globalData.filter(x=>x.id==v));
}

function render(data){
const list=document.getElementById('tokoList');
list.innerHTML='';
let totalU=0,k=0,kr=0;
data.forEach(t=>{
totalU+=t.laku*t.harga; k+=t.kacang; kr+=t.kerupuk;
const d=document.createElement('div');
d.className='bg-white p-4 rounded-xl shadow card';
d.innerHTML=`
<span class="text-xs font-bold">${t.jalur}</span>
<h3 class="font-bold">${t.nama}</h3>
<div class="grid grid-cols-2 gap-2 my-2">
<div>Kacang: <b>${t.kacang}</b></div>
<div>Kerupuk: <b>${t.kerupuk}</b></div>
</div>

<!-- DROPDOWN AKSI -->
<details class="mb-2">
<summary class="cursor-pointer text-sm font-bold text-blue-600">Aksi Toko â–¼</summary>
<div class="mt-2 flex gap-2">
<a href="${t.maps}" target="_blank" class="flex-1 text-center bg-blue-100 text-blue-700 py-2 rounded font-bold text-xs">Buka Maps</a>
${t.foto && t.foto.startsWith('http') ? `<a href="${t.foto}" target="_blank" class="flex-1 text-center bg-gray-100 py-2 rounded font-bold text-xs">Lihat Foto</a>` : ''}
</div>
</details>

<div class="flex gap-2">
<input type="number" value="${t.laku}" onchange="update(${t.id},this.value,'laku')" class="flex-1 border-b">
<select onchange="update(${t.id},this.value,'harga')" class="border-b">
<option value="1500" ${t.harga==1500?'selected':''}>1500</option>
<option value="1600" ${t.harga==1600?'selected':''}>1600</option>
</select>
</div>
<p class="text-right font-bold text-blue-600 mt-1">Rp ${(t.laku*t.harga).toLocaleString('id-ID')}</p>
<input type="text" value="${t.catatan}" onchange="update(${t.id},this.value,'catatan')" placeholder="Catatan" class="w-full mt-2 p-2 bg-gray-100 rounded">
`;
list.appendChild(d);
});
document.getElementById('statToko').innerText=globalData.length;
document.getElementById('statKacang').innerText=k;
document.getElementById('statKerupuk').innerText=kr;
document.getElementById('statUang').innerText='Rp '+totalU.toLocaleString('id-ID');
saveLocal();
}

function update(id,val,key){
const i=globalData.findIndex(x=>x.id===id);
globalData[i][key]=key==='catatan'?val:parseInt(val)||0;
render(globalData);
}

function exportCSV(){
const csv=Papa.unparse(globalData);
const b=new Blob([csv],{type:'text/csv'});
const a=document.createElement('a');
a.href=URL.createObjectURL(b);
a.download='tagihan_final.csv';
a.click();
}

function resetData(){
if(confirm('Reset semua data?')){
localStorage.removeItem('tagihan_final');
location.reload();
}
}
</script>
</body>
</html>
